!function(o,l){"use strict";var u={configure:function(){u.metabox=o("#cmb2-metabox-wptelegram_widget"),u.bot_token=u.metabox.find("#bot_token"),u.username=u.metabox.find("#username")},init:function(){u.configure(),u.metabox.on("blur","#bot_token,#username",u.handle_blur),u.metabox.on("click","#button-bot_token,#button-username",u.send_test)},send_test:function(e,t){if(u.bot_token.val().trim()&&u.validate("bot_token")){var a=o(this).attr("data-id");if("username"==a){if(!u.username.val().trim())return void alert(l.empty_username);if(!u.validate("username"))return}var n=u[a].val().replace(/[\s@]/g,"");switch(a){case"bot_token":u.test_bot_token(n);break;case"username":var s=u.bot_token.val();u.test_username("@"+n,s)}}else alert(l.empty_bot_token)},test_bot_token:function(e){u.send_ajax_request(e,"/getMe",{},u.handle_bot_token_test)},test_username:function(e,t){var a=prompt(l.test_message_prompt,l.test_message_text);null!=a&&u.send_ajax_request(t,"/sendMessage",{chat_id:e,text:a},u.handle_username_test)},send_ajax_request:function(e,t,a,n){var s="https://api.telegram.org/bot"+e+t;o.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:s,dataType:"json",crossDomain:!0,data:JSON.stringify(a),complete:n})},handle_blur:function(e){u.metabox.find(".info").addClass("hidden").siblings().remove();var t=o(this).attr("id"),a=u[t].val();""!=a&&u.validate(t)&&"username"==t&&u.get_chat_member_count("@"+a)},get_chat_member_count:function(e){u.send_ajax_request(u.bot_token.val(),"/getChatMembersCount",{chat_id:e},u.handle_chat_member_count)},handle_username_test:function(e,t){u.metabox.find("#username-chat-table").removeClass("hidden");var a="<td>"+u.username.val()+"</td>";if(null==e||""==e.responseText){o='<td colspan="3"><span style="color:#f10e0e;">'+l.error+" "+l.could_not_connect+"</span></td>";var n=r=""}else if(1==JSON.parse(e.responseText).ok)var s=JSON.parse(e.responseText).result,o="<td>"+s.chat.title+"</td>",r=(n="<td>"+s.chat.type+"</td>","<td>"+l.success+"</td>");else o="<td>"+JSON.parse(e.responseText).description+"</td>",n="<td>"+l.error+" "+e.status+"</td>",r="<td>"+l.failure+"</td>";var i='<tr class="wptelegram-widget-temp-rows">'+a+o+n+r+"</tr>";u.metabox.find("#username-chat-table tbody").append(i)},handle_bot_token_test:function(e,t){var a=u.metabox.find("#bot_token-info");if(a.removeClass("hidden"),null==e||""==e.responseText)a.text(""),a.append("<span>"+l.error+" "+l.could_not_connect+"</span>");else if(1==JSON.parse(e.responseText).ok){var n=JSON.parse(e.responseText).result;a.text(n.first_name+" "+(null==n.last_name?" ":n.last_name)+"(@"+n.username+")")}else a.text(l.error+" "+e.status+" ("+e.statusText+")")},handle_chat_member_count:function(e,t){if(null!=e&&""!=e.responseText){var a,n=u.metabox.find("#username-info");if(n.removeClass("hidden"),n.siblings().remove(),1==JSON.parse(e.responseText).ok)a=' <b style="color:#bb0f3b;">'+JSON.parse(e.responseText).result+"</b>";else n.addClass("hidden"),a=' <b style="color:#f10e0e;">'+l.error+" "+e.status+" ("+JSON.parse(e.responseText).description+")</b>";n.parent().append(a)}},validate:function(e){var t,a=u.metabox.find("#"+e).val().replace(/[\s@]/g,"");switch(u.metabox.find("#"+e).val(a),e){case"bot_token":t=new RegExp(/^\d{9}:[\w-]{35}$/);break;case"username":t=new RegExp(/^[a-z]\w{3,30}[^\W_]$/i)}return t.test(a)?(u.metabox.find("#"+e+"-err").addClass("hidden"),!0):(u.metabox.find("#"+e+"-err").removeClass("hidden"),!1)}},a={configure:function(){a.metabox=o("#wptelegram_widget_messages"),a.post_url=a.metabox.find("#post_url"),a.num_messages=a.metabox.find("#num_messages"),a.submit=a.metabox.find("#submit-pull")},init:function(){a.configure(),a.submit.click(a.pull_messages)},pull_messages:function(e){e.preventDefault();var t={action:"wptelegram_widget_pull_messages",nonce:a.metabox.find("#ajax_nonce").val(),post_url:a.post_url.val(),num_messages:a.num_messages.val()};a.send_ajax_request(t,a.handle_ajax_response)},send_ajax_request:function(e,t){o.ajax({contentType:"application/json; charset=utf-8",url:ajaxurl,dataType:"JSON",data:e,complete:t,success:function(){window.setTimeout(function(){location.reload()},2e3)}})},handle_ajax_response:function(e){var t;a.submit.siblings().remove(),t=null==e||""==e.responseText?l.could_not_connect:null!=JSON.parse(e.responseText).data?JSON.parse(e.responseText).data:e.statusText,a.submit.parent().append("&nbsp;<span>"+t+"</span>")}};o(document).ready(u.init),o(document).ready(a.init)}(jQuery,wptelegram_widget_I18n);