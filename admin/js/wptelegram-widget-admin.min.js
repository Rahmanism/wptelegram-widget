!function(o,i){"use strict";var d={configure:function(){d.metabox=o("#cmb2-metabox-wptelegram_widget"),d.bot_token=d.metabox.find("#bot_token"),d.username=d.metabox.find("#username")},init:function(){d.configure(),d.metabox.on("blur","#bot_token,#username",d.handle_blur),d.metabox.on("click","#button-bot_token,#button-username",d.send_test)},send_test:function(){if(d.bot_token.val().trim()&&d.validate("bot_token")){var e=o(this).attr("data-id");if("username"==e){if(!d.username.val().trim())return void window.alert(i.empty_username);if(!d.validate("username"))return}var t=d[e].val().replace(/[\s@]/g,"");switch(e){case"bot_token":d.test_bot_token(t);break;case"username":var n=d.bot_token.val();d.test_username("@"+t,n)}}else window.alert(i.empty_bot_token)},test_bot_token:function(e){d.send_ajax_request(e,"/getMe",{},d.handle_bot_token_test)},test_username:function(e,t){var n=window.prompt(i.test_message_prompt,i.test_message_text);null!=n&&d.send_ajax_request(t,"/sendMessage",{chat_id:e,text:n},d.handle_username_test)},send_ajax_request:function(e,t,n,a){var s="https://api.telegram.org/bot"+e+t;o.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:s,dataType:"json",crossDomain:!0,data:JSON.stringify(n),complete:a})},handle_blur:function(){d.metabox.find(".info").addClass("hidden").siblings().remove();var e=o(this).attr("id"),t=d[e].val();""!=t&&d.validate(e)&&"username"==e&&d.get_chat_member_count("@"+t)},get_chat_member_count:function(e){d.send_ajax_request(d.bot_token.val(),"/getChatMembersCount",{chat_id:e},d.handle_chat_member_count)},handle_username_test:function(e){d.metabox.find("#username-chat-table").removeClass("hidden");var t,n,a,s="<td>"+d.username.val()+"</td>";if(null==e||""==e.responseText)t='<td colspan="3"><span style="color:#f10e0e;">'+i.error+" "+i.could_not_connect+"</span></td>";else if(1==JSON.parse(e.responseText).ok){var o=JSON.parse(e.responseText).result;t="<td>"+o.chat.title+"</td>",n="<td>"+o.chat.type+"</td>",a="<td>"+i.success+"</td>"}else t="<td>"+JSON.parse(e.responseText).description+"</td>",n="<td>"+i.error+" "+e.status+"</td>",a="<td>"+i.failure+"</td>";var r='<tr class="wptelegram-widget-temp-rows">'+s+t+n+a+"</tr>";d.metabox.find("#username-chat-table tbody").append(r)},handle_bot_token_test:function(e){var t=d.metabox.find("#bot_token-info");if(t.removeClass("hidden"),null==e||""==e.responseText)t.text(""),t.append("<span>"+i.error+" "+i.could_not_connect+"</span>");else if(1==JSON.parse(e.responseText).ok){var n=JSON.parse(e.responseText).result;t.text(n.first_name+" "+(null==n.last_name?" ":n.last_name)+"(@"+n.username+")")}else t.text(i.error+" "+e.status+" ("+e.statusText+")")},handle_chat_member_count:function(e){if(null!=e&&""!=e.responseText){var t,n=d.metabox.find("#username-info");if(n.removeClass("hidden"),n.siblings().remove(),1==JSON.parse(e.responseText).ok)t=' <b style="color:#bb0f3b;">'+JSON.parse(e.responseText).result+"</b>";else n.addClass("hidden"),t=' <b style="color:#f10e0e;">'+i.error+" "+e.status+" ("+JSON.parse(e.responseText).description+")</b>";n.parent().append(t)}},validate:function(e){var t,n=d.metabox.find("#"+e).val().replace(/[\s@]/g,"");switch(d.metabox.find("#"+e).val(n),e){case"bot_token":t=new RegExp(/^\d{9}:[\w-]{35}$/);break;case"username":t=new RegExp(/^[a-z]\w{3,30}[^\W_]$/i)}return t.test(n)?(d.metabox.find("#"+e+"-err").addClass("hidden"),!0):(d.metabox.find("#"+e+"-err").removeClass("hidden"),!1)}},n={configure:function(){n.metabox=o("#wptelegram_widget_messages"),n.post_url=n.metabox.find("#post_url"),n.num_messages=n.metabox.find("#num_messages"),n.submit=n.metabox.find("#submit-pull")},init:function(){n.configure(),n.submit.click(n.pull_messages)},pull_messages:function(e){e.preventDefault();var t={action:"wptelegram_widget_pull_messages",nonce:n.metabox.find("#ajax_nonce").val(),post_url:n.post_url.val(),num_messages:n.num_messages.val()};n.send_ajax_request(t,n.handle_ajax_response)},send_ajax_request:function(e,t){o.ajax({contentType:"application/json; charset=utf-8",url:window.ajaxurl,dataType:"JSON",data:e,complete:t,success:function(){window.setTimeout(function(){location.reload()},2e3)}})},handle_ajax_response:function(e){var t;n.submit.siblings().remove(),t=null==e||""==e.responseText?i.could_not_connect:null!=JSON.parse(e.responseText).data?JSON.parse(e.responseText).data:e.statusText,n.submit.parent().append("&nbsp;<span>"+t+"</span>")}};o(document).ready(d.init),o(document).ready(n.init)}(jQuery,window.wptelegram_widget.I18n);